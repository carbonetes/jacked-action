var config = require('./config'),
    fs = require('fs.extra'),
    http = require('http'),
    path = require('path'),
    Q = require('q'),
    URL = require('url');

module.exports = function(name, version, url) {
    var deferred = Q.defer(),
        dir = path.join(config.directory, name, version),
        options = URL.parse(url);

    options.method = 'GET';

    console.log('installing ' + url + ' to ' + dir);

    Q.nfcall(fs.mkdirs, dir).then(function() {
        try {
            var filename = path.resolve(path.join(dir, path.basename(options.pathname)));
            var file = fs.createWriteStream(filename);

            var request = http.request(options, function(response) {
                response.on('data', function(data) {
                    file.write(data);
                }).on('end', function() {
                    file.end();
                    deferred.resolve();
                });
            });

            request.on('error', function(e) {
                deferred.reject('Error: ' + e);
            });
            request.end();
        } catch (e) {
            console.log(e);
            deferred.reject();
        }
    }, function() {
        deferred.reject();
    });

    return deferred;
};
