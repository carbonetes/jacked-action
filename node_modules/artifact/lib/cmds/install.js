var download = require('../download'),
    S3 = require('../repos/s3'),
    Q = require('q');

module.exports = function(artifact) {
    artifact.register('install', function(options) {
        return artifact.execute('resolve', options).then(install, Q.reject);

        function install(data) {
            var promises = [],
                unpack = options.unpack === 'false' || options.unpack === false ? false : true;

            if (data) {
                if (data.url) {
                    if (data.url.indexOf('s3.amazonaws.com') >= 0) {
                        promises.push(S3.download(data.name, data.version, data.url, unpack));
                    } else {
                        promises.push(download(data.name, data.version, data.url, unpack));
                    }
                }
                var dependencies = data.dependencies;
                if (dependencies) {
                    Object.keys(dependencies).forEach(function(key) {
                        promises.push(install(dependencies[key]));
                    });
                }
            }
            return promises.length > 0 ? Q.all(promises).then(function() {
                return Q.resolve();
            }) : Q.resolve();
        }
    });
};
